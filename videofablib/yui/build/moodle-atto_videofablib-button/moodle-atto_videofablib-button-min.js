YUI.add("moodle-atto_videofablib-button",function(l,e){var s={RESPONSIVE:"img-responsive",INPUTALT:"atto_videofablib_altentry",INPUTHEIGHT:"atto_videofablib_heightentry",INPUTSUBMIT:"atto_videofablib_urlentrysubmit",INPUTURL:"atto_videofablib_urlentry",INPUTSIZE:"atto_videofablib_size",INPUTWIDTH:"atto_videofablib_widthentry",IMAGEALTWARNING:"atto_videofablib_altwarning",IMAGEBROWSER:"atto_videofablib_openimagebrowser"},t={INPUTURL:"."+s.INPUTURL},o="atto_videofablib";l.namespace("M.atto_videofablib").Button=l.Base.create("button",l.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_selectedVideo:null,_attoform:null,_rawImageDimensions:null,initializer:function(){this.addButton({icon:"e/insert_edit_video",callback:this._displayDialogue,tags:".attovideofablib",tagMatchRequiresAll:!1}),this.editor.delegate("dblclick",this._displayDialogue,".attovideofablib",this),this.editor.delegate("click",this._handleClick,".attovideofablib",this),this.editor.on("dragover",function(e){e.preventDefault()},this),this.editor.on("dragenter",function(e){e.preventDefault()},this)},_handleClick:function(e){var t=e.target,i=this.get("host").getSelectionFromNode(t);this.get("host").getSelection()!==i&&this.get("host").setSelection(i)},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection(),!1!==this._currentSelection&&(this._rawImageDimensions=null,this.getDialogue({headerContent:M.util.get_string("imageproperties",o),width:"auto",focusAfterHide:!0,focusOnShowSelector:t.INPUTURL}).set("bodyContent",this._getDialogueContent()).show())},_getDialogueContent:function(){var e=l.Handlebars.compile('<form class="atto_attoform">{{#if showFilepicker}}<div class="mb-1"><label for="{{elementid}}_{{CSS.INPUTURL}}">{{get_string "enterurl" component}}</label><div class="input-group input-append w-100"><input class="form-control {{CSS.INPUTURL}}" type="url" id="{{elementid}}_{{CSS.INPUTURL}}" size="32"/><span class="input-group-append"><button class="btn btn-secondary {{CSS.IMAGEBROWSER}}" type="button">{{get_string "browserepositories" component}}</button></span></div></div>{{else}}<div class="mb-1"><label for="{{elementid}}_{{CSS.INPUTURL}}">{{get_string "enterurl" component}}</label><input class="form-control fullwidth {{CSS.INPUTURL}}" type="url" id="{{elementid}}_{{CSS.INPUTURL}}" size="32"/></div>{{/if}}<input type="hidden" class="{{CSS.INPUTCUSTOMSTYLE}}"/><br/><button class="btn btn-secondary {{CSS.INPUTSUBMIT}}" type="submit">{{get_string "saveimage" component}}</button></div></form>'),t=this.get("host").canShowFilepicker("media"),i=l.Node.create(e({elementid:this.get("host").get("elementid"),CSS:s,component:o,showFilepicker:t}));return this._attoform=i,this._applyImageProperties(this._attoform),this._attoform.one("."+s.INPUTURL).on("blur",this._urlChanged,this),this._attoform.one("."+s.INPUTURL).on("blur",this._urlChanged,this),this._attoform.one("."+s.INPUTSUBMIT).on("click",this._setVideo,this),t&&i.delegate("click",function(e){var t=this._attoform;e.preventDefault(),this.get("host").showFilepicker("media",this._getFilepickerCallback(t),this)},".atto_videofablib_openimagebrowser",this),i},_filepickerCallback:function(e){""!==e.url&&this._attoform.one("."+s.INPUTURL).set("value",e.url)},_getFilepickerCallback:function(t){return function(e){""!==e.url&&t.one("."+s.INPUTURL).set("value",e.url)}},_applyImageProperties:function(e){var t=this._getSelectedImageProperties();!1!==t&&t.src&&e.one("."+s.INPUTURL).set("value",t.src)},_getSelectedImageProperties:function(){var e,t={src:null},i=this.get("host").getSelectedNodes();return(i=i&&i.filter("iframe"))&&i.size()?(e=e.item(0),this._selectedVideo=e,t.src=e.getAttribute("src"),t):(this._selectedVideo=null,!1)},_setVideo:function(e){var t,i=this._attoform,o=i.one("."+s.INPUTURL).get("value"),n=this.get("host");e.preventDefault(),o.includes("youtube.com")&&!o.includes("embed")&&(o="https://www.youtube.com/embed/"+o.slice(-11)),this._updateWarning()||(n.focus(),""!==o&&(this._selectedVideo?n.setSelection(n.getSelectionFromNode(this._selectedVideo)):n.setSelection(this._currentSelection),t=l.Handlebars.compile('<div class="atto_videofablib_videowrapper"><iframe src="{{url}}" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"allowfullscreen=""></iframe></div>')({url:o}),this.get("host").insertContentAtFocusPoint(t),this.markUpdated()),this.getDialogue({focusAfterHide:null}).hide())},_updateWarning:function(){return!1}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});